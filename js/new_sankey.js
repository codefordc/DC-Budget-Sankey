
//***************** data ****************************************//  

myData = [{"source":"General Revenue","target":"General","value":3446022968},{"source":"General Revenue","target":"RI Higher Education Assistance Authority","value":147000},{"source":"Federal Funds","target":"General","value":2728339814},{"source":"Federal Funds","target":"Intermodal Surface Trans","value":399514755},{"source":"Federal Funds","target":"RI Higher Education Assistance Authority","value":15465693},{"source":"Restricted Receipts","target":"General","value":270058775},{"source":"Restricted Receipts","target":"Intermodal Surface Trans","value":12352761},{"source":"Restricted Receipts","target":"University - Colleges","value":644000},{"source":"Operating Transfers From Other Funds","target":"General","value":48423478},{"source":"Operating Transfers From Other Funds","target":"RI Capital Plan Fund","value":267335029},{"source":"Debt","target":"11-","value":4747781},{"source":"Debt","target":"Certificates Of Participation","value":18656925},{"source":"Debt","target":"Garvee/Motor Fuel Tax Bond Issues","value":32030000},{"source":"Other Funds","target":"General","value":12330081},{"source":"Other Funds","target":"Intermodal Surface Trans","value":253240247},{"source":"Other Funds","target":"RI Temporary Disability Insurance","value":198706124},{"source":"Other Funds","target":"Bond Capital","value":155363},{"source":"Other Funds","target":"Garvee/Motor Fuel Tax Bond Issues","value":10928029},{"source":"Other Funds","target":"State Lottery","value":692306302},{"source":"Other Funds","target":"Assessed Fringe Benefits Administration","value":37123794},{"source":"Other Funds","target":"Central Utilities","value":14244902},{"source":"Other Funds","target":"Central Mail","value":5617173},{"source":"Other Funds","target":"Centrex","value":4080029},{"source":"Other Funds","target":"Automotive Maintenance","value":13733063},{"source":"Other Funds","target":"Central Distribution Center","value":6739558},{"source":"Other Funds","target":"Correctional Industries","value":7704793},{"source":"Other Funds","target":"Records Center","value":882436},{"source":"Other Funds","target":"Surplus Property Internal Service Fund","value":2500},{"source":"Other Funds","target":"Health Insurance Fund","value":235532939},{"source":"Other Funds","target":"Capitol Police Fund","value":1060301},{"source":"Other Funds","target":"Employment Security Trust","value":218500000},{"source":"Other Funds","target":"Retired Employees Health Fund","value":49089615},{"source":"Other Funds","target":"Bog Retiree Health Fund","value":2536462},{"source":"Other Funds","target":"Ripta Health Fund","value":14594818},{"source":"Other Funds","target":"Permanent School","value":359000},{"source":"Other Funds","target":"Touro Jewish Synagogue","value":200000},{"source":"Other Funds","target":"Teacher Retiree Health Fund","value":7531279},{"source":"Other Funds","target":"State Police Retiree Health Fund","value":3073102},{"source":"Other Funds","target":"Legislative Retiree Health Fund","value":772532},{"source":"Other Funds","target":"Judicial Retiree Health","value":931493},{"source":"Other Funds","target":"University - Colleges","value":849745005},{"source":"Other Funds","target":"RI Higher Education Assistance Authority","value":8339268},{"source":"Other Funds","target":"Ri Industrial-Recreational Building Authority","value":562975},{"source":"General","target":"General Assembly - Constitution","value":37781122},{"source":"General","target":"Executive Department","value":4511489},{"source":"General","target":"Office Of Lieutenant Governor","value":1084499},{"source":"General","target":"Military Staff","value":17057696},{"source":"General","target":"RI Emergency Management Agency","value":20450976},{"source":"General","target":"Governor's Commission On Disabilities","value":508257},{"source":"General","target":"Commission On The Deaf & Hard Of Hearing","value":471540},{"source":"General","target":"RI Council On The Arts","value":2912011},{"source":"General","target":"Historical Preservation And Heritage Commission","value":4002933},{"source":"General","target":"Office Of Health And Human Services","value":2391356418},{"source":"General","target":"Board Of Elections","value":4137950},{"source":"General","target":"RI Ethics Commission","value":1576550},{"source":"General","target":"Public Utilities Commission","value":8459886},{"source":"General","target":"Office Of The Child Advocate","value":658262},{"source":"General","target":"RI Commission For Human Rights","value":1471587},{"source":"General","target":"Office Of The Mental Health Advocate","value":491504},{"source":"General","target":"Office Of Public Defender","value":11325714},{"source":"General","target":"Coastal Resources Management Council","value":4197121},{"source":"General","target":"RI Atomic Energy Commission","value":1167197},{"source":"General","target":"Public Telecommunications Authority","value":425000},{"source":"General","target":"RI Higher Education Assistance Authority","value":4500000},{"source":"General","target":"State","value":7837670},{"source":"General","target":"Attorney General","value":36365551},{"source":"General","target":"Treasury Department","value":35012306},{"source":"General","target":"Administration","value":398834213},{"source":"General","target":"Human Services","value":649364755},{"source":"General","target":"Business Regulation","value":12931738},{"source":"General","target":"Elementary And Secondary Education","value":1239741320},{"source":"General","target":"Labor And Training","value":101961244},{"source":"General","target":"Environmental Management","value":86589407},{"source":"General","target":"Health","value":122531163},{"source":"General","target":"Behavioral Healthcare Developmental Disabilities And Hospitals","value":357867906.3},{"source":"General","target":"Corrections","value":188828720},{"source":"General","target":"Children Youth And Families","value":207461164},{"source":"General","target":"Revenue","value":117685449},{"source":"General","target":"Public Safety","value":119386228},{"source":"General","target":"Public Higher Education","value":9655716},{"source":"General","target":"University Of RI","value":93462727},{"source":"General","target":"RI College","value":48819627},{"source":"General","target":"Community College Of RI","value":48364428},{"source":"General","target":"Judicial Department - Constitution","value":103926072},{"source":"11-","target":"Revenue","value":4747781},{"source":"Intermodal Surface Trans","target":"Transportation","value":665107763},{"source":"RI Temporary Disability Insurance","target":"Treasury Department","value":220608},{"source":"RI Temporary Disability Insurance","target":"Labor And Training","value":198485516},{"source":"RI Capital Plan Fund","target":"Military Staff","value":1390000},{"source":"RI Capital Plan Fund","target":"RI Emergency Management Agency","value":167000},{"source":"RI Capital Plan Fund","target":"Governor'S Commission On Disabilities","value":1000000},{"source":"RI Capital Plan Fund","target":"Historical Preservation And Heritage Commission","value":1900000},{"source":"RI Capital Plan Fund","target":"Coastal Resources Management Council","value":750000},{"source":"RI Capital Plan Fund","target":"RI Atomic Energy Commission","value":100000},{"source":"RI Capital Plan Fund","target":"State","value":500000},{"source":"RI Capital Plan Fund","target":"Attorney General","value":300000},{"source":"RI Capital Plan Fund","target":"Administration","value":132547322},{"source":"RI Capital Plan Fund","target":"Human Services","value":165000},{"source":"RI Capital Plan Fund","target":"Transportation","value":36323529},{"source":"RI Capital Plan Fund","target":"Elementary And Secondary Education","value":5887328},{"source":"RI Capital Plan Fund","target":"Labor And Training","value":2005996},{"source":"RI Capital Plan Fund","target":"Environmental Management","value":17059170},{"source":"RI Capital Plan Fund","target":"Behavioral Healthcare Developmental Disabilities And Hospitals","value":7207286},{"source":"RI Capital Plan Fund","target":"Corrections","value":19527438},{"source":"RI Capital Plan Fund","target":"Children Youth And Families","value":2911831},{"source":"RI Capital Plan Fund","target":"Public Safety","value":6799959},{"source":"RI Capital Plan Fund","target":"University Of RI","value":18470000},{"source":"RI Capital Plan Fund","target":"RI College","value":6834865},{"source":"RI Capital Plan Fund","target":"Community College Of RI","value":4138305},{"source":"RI Capital Plan Fund","target":"Judicial Department - Constitution","value":1350000},{"source":"Bond Capital","target":"Administration","value":155363},{"source":"Certificates Of Participation","target":"Attorney General","value":1000000},{"source":"Certificates Of Participation","target":"Administration","value":6370221},{"source":"Certificates Of Participation","target":"Elementary And Secondary Education","value":6125876},{"source":"Certificates Of Participation","target":"Revenue","value":4140663},{"source":"Certificates Of Participation","target":"University Of RI","value":1020165},{"source":"Garvee/Motor Fuel Tax Bond Issues","target":"Transportation","value":42958029},{"source":"State Lottery","target":"Revenue","value":692306302},{"source":"Assessed Fringe Benefits Administration","target":"Administration","value":37123794},{"source":"Central Utilities","target":"Administration","value":14244902},{"source":"Central Mail","target":"Administration","value":5617173},{"source":"Centrex","target":"Administration","value":4080029},{"source":"Automotive Maintenance","target":"Administration","value":13733063},{"source":"Central Distribution Center","target":"Corrections","value":6739558},{"source":"Correctional Industries","target":"Corrections","value":7704793},{"source":"Records Center","target":"State","value":882436},{"source":"Surplus Property Internal Service Fund","target":"Administration","value":2500},{"source":"Health Insurance Fund","target":"Administration","value":235532939},{"source":"Capitol Police Fund","target":"Public Safety","value":1060301},{"source":"Employment Security Trust","target":"Labor And Training","value":218500000},{"source":"Retired Employees Health Fund","target":"Administration","value":49089615},{"source":"Bog Retiree Health Fund","target":"Administration","value":2536462},{"source":"Ripta Health Fund","target":"Administration","value":14594818},{"source":"Permanent School","target":"Elementary And Secondary Education","value":359000},{"source":"Touro Jewish Synagogue","target":"Treasury Department","value":200000},{"source":"Teacher Retiree Health Fund","target":"Administration","value":7531279},{"source":"State Police Retiree Health Fund","target":"Administration","value":3073102},{"source":"Legislative Retiree Health Fund","target":"Administration","value":772532},{"source":"Judicial Retiree Health","target":"Administration","value":931493},{"source":"University - Colleges","target":"University Of RI","value":631426781},{"source":"University - Colleges","target":"RI College","value":115536249},{"source":"University - Colleges","target":"Community College Of RI","value":103425975},{"source":"RI Higher Education Assistance Authority","target":"54-RI Higher Education Assistance Authority","value":23951961}]


//***************** set up variables ****************************// 


var margin = {top: 20, right: 10, bottom: 10, left: 10},
    width = 960 - margin.left - margin.right,
    height = 620 - margin.top - margin.bottom;



//***************** sankey plugin ******************************// 

d3.sankey = function() {
  var sankey = {},
      nodeWidth = 24,
      nodePadding = 8,
      size = [1, 1],
      nodes = [],
      links = [];

  sankey.nodeWidth = function(_) {
    if (!arguments.length) {
      return nodeWidth;
    }
    nodeWidth = +_;
    return sankey;
  };

  sankey.nodePadding = function(_) {
    if (!arguments.length) {
      return nodePadding;
    }
    nodePadding = +_;
    return sankey;
  };

  sankey.nodes = function(_) {
    if (!arguments.length) {
      return nodes;
    }
    nodes = _;
    return sankey;
  };

  sankey.links = function(_) {
    if (!arguments.length) {
      return links;
    }
    links = _;
    return sankey;
  };

  sankey.size = function(_) {
    if (!arguments.length) {
      return size;
    }
    size = _;
    return sankey;
  };

  sankey.layout = function(iterations) {
    computeNodeLinks();
    computeNodeValues();
    computeNodeBreadths();
    computeNodeDepths(iterations);
    computeLinkDepths();
    return sankey;
  };

  sankey.relayout = function() {
    computeLinkDepths();
    return sankey;
  };

  sankey.link = function() {
    var curvature = .35;

    function link(d) {
      var x0 = d.source.x + d.source.dx, 
          x1 = d.target.x, 
          xi = d3.interpolateNumber(x0, x1), 
          x2 = xi(curvature), 
          x3 = xi(1 - curvature), 
          y0 = d.source.y + d.sy + d.dy / 2, 
          y1 = d.target.y + d.ty + d.dy / 2; 
      return "M" + x0 + "," + y0
           + "C" + x2 + "," + y0
           + " " + x3 + "," + y1
           + " " + x1 + "," + y1; 
    }

    link.curvature = function(_) {
      if (!arguments.length) {
        return curvature;
      }
      curvature = +_;
      return link;
    };

    return link;
  };


  function computeNodeLinks() { 
    nodes.forEach(function(node) {
      node.sourceLinks = [];
      node.targetLinks = [];
    });
    links.forEach(function(link) {
      var source = link.source,
          target = link.target;
      if (typeof source === "number") {
        source = link.source = nodes[link.source];
      }
      if (typeof target === "number") {
        target = link.target = nodes[link.target];
      }
      source.sourceLinks.push(link);
      target.targetLinks.push(link);
    });
  }

  function computeNodeValues() {
    nodes.forEach(function(node) {
      node.value = Math.max(
        d3.sum(node.sourceLinks, value),
        d3.sum(node.targetLinks, value)
      );
    });
  }

  function computeNodeBreadths() {
    var remainingNodes = nodes,
        nextNodes,
        x = 0;

    while (remainingNodes.length) {
      nextNodes = [];
      remainingNodes.forEach(function(node) {
        node.x = x;
        node.dx = nodeWidth;
        node.sourceLinks.forEach(function(link) {
          nextNodes.push(link.target);
        });
      });
      remainingNodes = nextNodes;
      ++x;
    }

    //
    moveSinksRight(x);
    scaleNodeBreadths((width - nodeWidth) / (x - 1));
  }

  function moveSourcesRight() {
    nodes.forEach(function(node) {
      if (!node.targetLinks.length) {
        node.x = d3.min(node.sourceLinks, function(d) { return d.target.x; }) - 1;
      }
    });
  }

  function moveSinksRight(x) {
    nodes.forEach(function(node) {
      if (!node.sourceLinks.length) {
        node.x = x - 1;
      }
    });
  }

  function scaleNodeBreadths(kx) {
    nodes.forEach(function(node) {
      node.x *= kx;
    });
  }

  function computeNodeDepths(iterations) {
    var nodesByBreadth = d3.nest()
        .key(function(d) { return d.x; })
        .sortKeys(d3.ascending)
        .entries(nodes)
        .map(function(d) { return d.values; });

    //
    initializeNodeDepth();
    resolveCollisions();
    for (var alpha = 1; iterations > 0; --iterations) {
      relaxRightToLeft(alpha *= .99);
      resolveCollisions();
      relaxLeftToRight(alpha);
      resolveCollisions();
    }

    function initializeNodeDepth() {
      var ky = d3.min(nodesByBreadth, function(nodes) {
        return (size[1] - (nodes.length - 1) * nodePadding) / d3.sum(nodes, value);
      });

      nodesByBreadth.forEach(function(nodes) {
        nodes.forEach(function(node, i) {
          node.y = i;
          node.dy = node.value * ky;
        });
      });

      links.forEach(function(link) {
        link.dy = link.value * ky;
      });
    }

    function relaxLeftToRight(alpha) {
      nodesByBreadth.forEach(function(nodes, breadth) {
        nodes.forEach(function(node) {
          if (node.targetLinks.length) {
            var y = d3.sum(node.targetLinks, weightedSource) / d3.sum(node.targetLinks, value);
            node.y += (y - center(node)) * alpha;
          }
        });
      });

      function weightedSource(link) {
        return center(link.source) * link.value;
      }
    }

    function relaxRightToLeft(alpha) {
      nodesByBreadth.slice().reverse().forEach(function(nodes) {
        nodes.forEach(function(node) {
          if (node.sourceLinks.length) {
            var y = d3.sum(node.sourceLinks, weightedTarget) / d3.sum(node.sourceLinks, value);
            node.y += (y - center(node)) * alpha;
          }
        });
      });

      function weightedTarget(link) {
        return center(link.target) * link.value;
      }
    }

    function resolveCollisions() {
      nodesByBreadth.forEach(function(nodes) {
        var node,
            dy,
            y0 = 0,
            n = nodes.length,
            i;

        // Push any overlapping nodes down.
        nodes.sort(ascendingDepth);
        for (i = 0; i < n; ++i) {
          node = nodes[i];
          dy = y0 - node.y;
          if (dy > 0) node.y += dy;
          y0 = node.y + node.dy + nodePadding;
        }

        // If the bottommost node goes outside the bounds, push it back up.
        dy = y0 - nodePadding - size[1];
        if (dy > 0) {
          y0 = node.y -= dy;

          // Push any overlapping nodes back up.
          for (i = n - 2; i >= 0; --i) {
            node = nodes[i];
            dy = node.y + node.dy + nodePadding - y0;
            if (dy > 0) node.y -= dy;
            y0 = node.y;
          }
        }
      });
    }

    function ascendingDepth(a, b) {
      return a.y - b.y;
    }
  }

  function computeLinkDepths() { // this is where the order of is figured out... wrong by the way
    nodes.forEach(function(node) {
      node.sourceLinks.sort(ascendingTargetDepth);
      node.targetLinks.sort(ascendingSourceDepth);
      ////console.log("this is where order is done",node.sourceLinks);
    });
    nodes.forEach(function(node) {
      var sy = 0, ty = 0;
      node.sourceLinks.forEach(function(link) {
        link.sy = sy;
        sy += link.dy;
      });
      node.targetLinks.forEach(function(link) {
        link.ty = ty;
        ty += link.dy;
      });
    });

    function ascendingSourceDepth(a, b) {
      return a.source.y - b.source.y;

    }

    function ascendingTargetDepth(a, b) {
      return a.target.y - b.target.y;
    }
  }

  function center(node) {
    return node.y + node.dy / 2;
  }

  function value(link) {
    return link.value;
  }

  return sankey;
};







//********************** model *******************************
//
//
//
//************************************************************
(function () {
  var sankey, obj, tip, tip2, graph_labels, graph_rects, graph_headers, catagory,
    chart, allLinks, allNodes, rS, pS, lS;



  var formatNumber = d3.format(",.0f"),
      format = function(d) { return "$" + formatNumber(d); },
      color = d3.scale.category20();

  function dataModel(d1) {

      var obj =   { 
                      "eachNodes" : [], 
                      "linkers" : [], 
                      "fullList" : [] 
                  };

      var next = d1.filter( function ( row ) {
    		
          return row[ "value" ] > 0;

    	});

      next.forEach( function ( d ) {
          obj.eachNodes.push( {  "name": d.source } );
          obj.eachNodes.push( {  "name": d.target } );
          obj.linkers.push( {     
                              "source": d.source,
                              "target": d.target,
                              "sourceName": d.source,
                              "targetName": d.target,
                              "theColor": undefined,
                              "num": 0,
                              "type": "link",
                              "value": +d.value 
                          } );
      } );

          // return only the distinct / unique eachNodes
      obj.eachNodes = d3.keys( d3.nest()
          .key(function (d) { return d.name; } )
          .map( obj.eachNodes )
      );

      // loop through each link replacing the text with its index from node
      obj.linkers.forEach( function ( d, i ) {
          obj.linkers[ i ].source = obj.eachNodes.indexOf( obj.linkers[ i ].source );
          obj.linkers[ i ].theColor = obj.linkers[ i ].source;
          obj.linkers[ i ].target = obj.eachNodes.indexOf( obj.linkers[ i ].target );
          obj.linkers[ i ].num = i;
      } );

      // adds the colors to the nodes
      obj.eachNodes.forEach(function ( d, i ) {
          obj.eachNodes[ i ] =  { 
                                  "name": d,
                                  "theColor": color(i),
                                  "strokeColor": undefined,
                                  "num": i 
                              };
      } );

      obj.eachNodes.forEach( function ( d, i ) {
          var result = d3.rgb( obj.eachNodes[ i ].theColor ).darker( 0.3 );
          obj.eachNodes[ i ].strokeColor = result;
      } );


          // function to get all of the colors to the links
      obj.linkers.forEach( function ( d, i ) {
          obj.linkers[ i ].theColor = obj.eachNodes[ obj.linkers[ i ].theColor ].theColor;
      } );

    return obj;

  }

  obj = dataModel(myData);




   // gathers info for other dashboard items and tool tip. Not being used right now.
  function report_out(its) {

      var link_state = {},  
          data = its.datum(),
          name = data.name || null,
          source = data.sourceName || null,
          target = data.targetName || null,
          total = data.value,
          title = name ? "NodeInfo" : "LinkInfo";

      link_state = name ? { 
                              "title": title, 
                              "name": name, 
                              "total": total 
                          } :
                          { 
                              "title": title, 
                              "source": source, 
                              "target": target, 
                              "total": total 
                          };

    return link_state;

  }







  //********************** view ********************************
  //
  //
  //
  //************************************************************

    //---------------- create layout for the chart ------------------------------------

  function Svg() {

      var svg = {};

      svg = d3.select("#chart").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
          .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
          
      return svg;

  }

  chart = Object.create( Svg() );




    //---------------- activate tips ------------------------------------

  tip = Object.create( theTip() );

  tip2 = Object.create( theTip() );

  function floorFigure(figure, decimals){
      if (!decimals) decimals = 2;
      var d = Math.pow(10,decimals);
      return (parseInt(figure*d)/d).toFixed(decimals);
  };

  var grandTotal = 9894215162; 
  tip.attr( 'class', 'd3-tip' )
      .html( function ( d ) {
          var template_node =   [ 
                          d.name, 
                          "<br>", 
                          "<strong>Total:</strong> <span style='color:#1A3013'>", 
                          format(d.value),
                          "</span><br>",
                          "<span style='color:red; font: 14px'>",
                          floorFigure(d.value/grandTotal*100, 3),
                          "% of Budget",
                          "<span>"
                      ],
              print = template_node.join("");

          return print;

  });

  tip2.attr( 'class', 'd3-tip' )
      .html( function ( d ) {
          var template_link =   [ 
                          d.sourceName, 
                          " → ", 
                          d.targetName, 
                          "<br>" ,
                          "<strong>Total:</strong> <span style='color:#1A3013'>",
                          format(d.value),
                          "</span><br>",
                          "<span style='color:red; font: 14px'>",
                          floorFigure(d.value/grandTotal*100, 3),
                          "% of Budget",
                          "<span>"
                      ],
              print = template_link.join("");

          return print;
              
  });



    //---------------- activate sankey plugin ------------------------------------

  sankey = Object.create( d3.sankey() );


  sankey.nodeWidth( 30 );

  sankey.nodePadding( 4 );

  sankey.size( [ width, height ] );

  sankey.nodes( obj.eachNodes );

  sankey.links( obj.linkers );
    // //console.log(obj.linkers);

  sankey.layout();




  //---------------- links -----------------------------------------------------



  pS = {

      link_stroke_width : function ( d ) {
          return Math.max( 2, d.dy );
      },

      link_stroke_width_hover : function( d ) {
          return Math.max( 4, d.dy );
      },

      link_color : function (d, i) {
          if ( d.value > 3000000 ) {
              return d.theColor;
          } else {
              return d3.rgb( d.theColor ).darker( 2.5 );
          }
      }
  };


  pS.link_init_style =    { 
                              "fill": "none", 
                              "stroke-opacity": 0.1, 
                              "stroke-width": pS.link_stroke_width, 
                              "stroke": pS.link_color
                          };

  pS.link_reset_style_1 = { 
                              "stroke-opacity": 0.2 
                          };

  pS.link_reset_style_2 = { 
                              "stroke-width": pS.link_stroke_width, 
                              "stroke": pS.link_color 
                          }

  pS.link_hovered =       {
                              "stroke-opacity": 0.6,
                              "stroke-width": pS.link_stroke_width_hover
                          };

  pS.link_not_hovered =   {
                              "stroke-width": pS.link_stroke_width, 
                              "stroke-opacity": 0.05
                          };

  pS.link_from_node =     {
                              "stroke-opacity": 0.5,
                              "stroke-width": pS.link_stroke_width
                          };

  pS.link_not_from_node = {
                              "stroke-opacity": 0,
                              "stroke-width": pS.link_stroke_width
                          };


  function BudgetLinks() {
    
      var theLink = {};

      theLink = chart.selectAll("#chart")
              .data( obj.linkers )
          .enter().append( "path" )
              .attr( "class", "link" )
              .attr( "d", sankey.link() )
              .style( pS.link_init_style )
              .sort( function( a, b ) { return b.dy - a.dy; } );
              
      return theLink;

  }




  graph_links = Object.create( BudgetLinks() );

  graph_links
      .on( "mouseover", mouseover )
      .on( 'mouseout', mouseout )
      .on( 'mouseenter', tip2.show )
      .on( 'mouseleave', tip2.hide );



  var durationHelp = function ( obj ) { // function affects the duration of transition for smaller links {thin links change fast}
          var dyValue = obj.dy * 100;
          ////console.log("duration", dyValue);
          if ( dyValue < 270 ) {
              return 95;
          } else {
              return 500
          }
      }


  function link_over( its, other_links, filtered_Nodes ) {
      
      var currentLink = its.datum(),
          targetLink = its,
          allNodes = d3.selectAll("rect"),
          locationSource = currentLink.sourceName,
          locationTarget = currentLink.targetName;
    
      targetLink.transition().duration( durationHelp( currentLink ))
          .style( pS.link_hovered );

      other_links = d3.selectAll( "path" ).filter( function ( d ) { return d !== currentLink; } )
    
      other_links.transition().delay( 750 ).duration( 1000 )
          .style( pS.link_not_hovered );

      filtered_Nodes = allNodes.filter( function ( d ) { // returns true or false making node lighten.  I need a better method
          var result1 = d.name === locationSource,
              result2 = d.name === locationTarget;
          if ( result1 ) { 
              return false;
          } else if ( result2 ) {
              return false;
          } else {
              return true;
          }
      });

      filtered_Nodes.transition()
              .duration( 1000 )
          .style( rS.node_not_from_link );

  }


  function link_out( its ) {
      
      var allLink = d3.selectAll( "path" ),
          allNodes = d3.selectAll( "rect" ),
          targetLink = its,
          other_links;

      targetLink.transition()
          .style( pS.link_reset_style_1 )
              .duration(1500)
          .style( pS.link_reset_style_2 );

      other_links = allLink.filter( function(d) { return d !== its.datum(); } );

      other_links.transition().duration( 0900 )
          .style( pS.link_init_style );

      allNodes.transition().duration( 1500 )
          .style( rS.main_node_style );

  }
        

//---------------- labels --------------------------------------------------------
    
    // ***** all parts of the graph_labels creation ****** (text)

  function Labels() {

      var theLabel = {};

      theLabel = chart.append("g").selectAll("text")
              .data(sankey.nodes())
          .enter().append("g")
              .attr( "class", "words" )
              .attr( "transform", function ( d ) { return "translate(" + d.x + "," + d.y + ")"; } )

      return theLabel;

  }


  graph_labels = Object.create( Labels() );

  lS = {}; // label styles

  lS.font_size = function ( d ) {
        ////console.log("new d.dy",d.dy);
          if ( d.dy > 50 ) { 
              return 15 + 'px';
          } else if ( d.dy <= 1.5 ) {
              return 8 + 'px';
          } else if ( d.dy <= 3 ) {
              return 10 + 'px';
          } else if ( d.dy <= 8 ) {
              return 11 + 'px';
          } else if ( d.dy <= 20 ) {
              return 12.5 + 'px';
          } else {
              return 13 + 'px';
          }
      }

  lS.font_color = function ( d ) {
        ////console.log("new d.dy",d.dy);
          if ( d.dy > 50 ) { 
              return "#000010";
          } else if ( d.dy <= 1.5 ) {
              return "#9AADB2"; //B7CDD4 B4CAD1 9AADB2
          } else if ( d.dy <= 3 ) {
              return "#343F47";
          } else if ( d.dy <= 8 ) {
              return "#252D33";
          } else if ( d.dy <= 20 ) {
              return "#14191C";
          } else {
              return "#111417";
          }
      }

  lS.font_opacity = function ( d ) { 
          if ( d.dy < 1.5 ) { 
              return 0 ; 
          } 
      }

  lS.label_style =   {
                          "font-size": lS.font_size,
                          "fill": lS.font_color,
                          //"fill-opacity": lS.font_opacity,
                          "pointer-events": "none",
                          "z-index": 10,
                          "text-shadow": 0 + "" +1 + "px " + 0 + " #fff"
                      };


  graph_labels.append("text")
      .attr("class", "labels")
      .attr( "x", -6 )
      .attr( "y", function ( d ) { return d.dy / 2; } )
      .attr( "dy", ".35em" )
      .attr( "text-anchor", "end" )
      .attr( "transform", null )
      .text( function ( d ) { if ( d.dy > 1.5 ) { return d.name; } } )
      .style( lS.label_style )
      .filter( function ( d ) { return d.x < width / 2; } ) //seem to affect what side text is shown
      .attr( "x", 6 + sankey.nodeWidth() )
      .attr( "text-anchor", "start" );

  var allLables = graph_labels


  graph_headers = Object.create( Labels() );

  var catagory = ["Revenue Source", "Fund", "", "Agency"];

  graph_headers.append( "text" )
      .attr( "x", sankey.nodeWidth() )
      .attr( "dy", ".35em" )
      .attr( "text-anchor", "end" )
      .attr( "transform", null )
      .text( function ( d, i ) { if ( d.y === 0 ) { return catagory.shift(); } } )
      .attr( "y", function ( d ) { return d.y - .7 + "em" ; } )
      .style( "font-size", 18 + "px" )
      .filter( function( d ) { return d.x < width / 1.2; } ) // filter out most to text-anchor at the begining
      .attr( "x", 0 )
      .attr( "text-anchor", "start" );




    //---------------- nodes --------------------------------------------------------



    // create the base code that forms off of the rects
  function BudgetNodes() {

      var theNode = {};

      theNode = chart.selectAll("#chart")
              .data(obj.eachNodes)
          .enter().append( "rect" )
              // .attr( "class", "node" )
              .attr( "transform", function ( d ) { return "translate(" + d.x + "," + d.y + ")"; } )

      return theNode;

  }




   // ***** all parts of the graph_rects creation ****** (rect)

  graph_rects = Object.create( BudgetNodes() );


  rS = {}; // rectangle styles

  rS.node_fill_color = function ( d, i ) { return d.theColor; }

  rS.node_stroke_color = function ( d ) { return d.strokeColor; }

  rS.node_stroke_width = function ( d ) {
          var value = parseFloat(d.dy);
          var higher = value * 100;
          var num = [];
          ////console.log(d.dy);
          if (higher < 270) {
              num.push(6 + "px");
          } else {
              num.push(2 + "px");
          }

          return num;
      }


  rS.px1 = function () { 
          var arr = [ 1, "px"]; 
          var print = arr.join(""); 
          return print;
      }

  rS.main_node_style = {
                      "stroke-opacity": 1.0,
                      "fill-opacity": 0.8,
                      "shape-rendering": "crispEdges",
                      "overflow": "visible",
                      "fill": rS.node_fill_color,
                      "stroke": rS.node_stroke_color,
                      "stroke-width": rS.px1,
                      "z-index": 1000
                    };

  rS.node_hovered =  {
                    "fill-opacity": 0.7,
                    "stroke-width": rS.node_stroke_width,
                    "z-index": -100
                  };

  rS.node_not_hovered =  {
                          "stroke-width": rS.px1,
                          "stroke-opacity": 1.0,
                          "fill-opacity": 0
                      };

  rS.node_from_link =  {
                      "stroke-width": rS.px1,
                      "stroke-opacity": 1.0,
                      "fill-opacity": 0.6
                    };


  rS.node_not_from_link = {
                          "stroke-opacity": 0.6,
                          "stroke-width": rS.px1,
                          "fill-opacity": 0.0
                        };

  rS.node_return = {
                  "fill-opacity": 0.8,
                  "stroke-opacity": 1.0,
                  "stroke-width": rS.px1
                };


    //make the nodes
  graph_rects
      .attr( "class", "node" )
      .attr( "height", function ( d ) { return d.dy; } )
      .attr( "width", sankey.nodeWidth() )
      .style( rS.main_node_style );

  graph_rects.on( "mouseover", mouseover )
      .on( "mouseout", mouseout)
      .on( "mouseenter", tip.show)
      .on( "mouseleave" , tip.hide);

  //pick_all_rect = d3.selectAll( "rect" );




  function node_over( its, data, other_nodes, filtered_Links, not_filtered_links ) {

      var locationName =data.name;
      
      its.transition().duration( 0002 ).style( rS.node_hovered );

      allNodes = d3.selectAll( "rect" );

      other_nodes = allNodes.filter( function ( d ) { // loops through and returns true when not compValue
          return d !== data; 
      } );

      other_nodes.transition().delay( 500 ).duration( 1000 ).style( rS.node_not_hovered );

      allLinks = d3.selectAll( "path" );

      filtered_Links = allLinks.filter( function ( d ) {
          var result1 = d.sourceName === locationName,
              result2 = d.targetName === locationName;
          if (result1) { 
              return true;
          } else if (result2) {
              return true;
          } else {
              return false;
              }
      } );

      not_filtered_links = allLinks.filter( function ( d ) {
          var result1 = d.sourceName === locationName,
              result2 = d.targetName === locationName;
          if (!result1) { 
              return true;
          } else if (!result2) {
              return true;
          } else {
              return false;
              }
      } );

      not_filtered_links.transition().duration( 1500 ).style( pS.link_not_from_node );
      filtered_Links.transition().duration( 1500 ).style( pS.link_from_node );

  }


  function node_out( its ) {

      var allNodes = d3.selectAll( "rect" ),
          allLinks = d3.selectAll( "path" ),
          othter_nodes;

      its.transition().duration( 250 ).style( rS.node_return );

      othter_nodes = allNodes.filter( function ( d ) { return d !== its.datum(); }) ;
      //console.log("the node out",othter_nodes);
      othter_nodes.transition().delay( 500 ).style( rS.node_return );

      allLinks.transition().duration( 1500 ).style( pS.link_init_style );

  }










      



  //********************** controller ***************************
  //
  //
  //
  //************************************************************



  function focus_on(its) {
      var data = its.datum();

      if ( data.type !== "link" ) {
          node_over( its, data );
      }
      else {
          link_over( its, data );
      }

  }

  function focus_out( its ) {

      if ( its.datum().type === "link" ) {
        link_out( its );
      }
      else {
        node_out( its );
      }

  }


  function mouseover() {

      var target = d3.select( this );

      focus_on( target );

      report_out( target );

  }

  function mouseout() {

      var target = d3.select( this );

      focus_out( target );

  }


  chart.call( theTip );
})();
